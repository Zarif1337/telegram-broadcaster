import telebot
import time
import os
import requests
import random
from datetime import datetime
import pytz

# --- ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ---
API_TOKEN = os.environ['MY_BOT_TOKEN']
CHANNEL_ID = os.environ['MY_CHANNEL_ID']

# ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ú‡ßã‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
bd_timezone = pytz.timezone("Asia/Dhaka")

# ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú (‡¶∏‡¶ï‡¶æ‡¶≤ ‡ß¨‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶§ ‡ßß‡ß¶‡¶ü‡¶æ)
day_messages = [
    "‡¶π‡ßç‡¶Ø‡¶æ‡¶≤‡ßã ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ‡¶∞‡¶æ, ‡¶ï‡¶ø ‡¶ñ‡¶¨‡¶∞?",
    "‡¶ì‡¶™‡¶∞‡ßá‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá ‡¶ï‡¶ø ‡¶∞‡¶ø‡¶è‡¶ï‡ßç‡¶ü ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßã?",
    "‡¶è‡¶á ‡¶Ö‡¶∏‡¶Æ‡ßü‡ßá ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá ‡¶ï‡¶ø ‡¶ï‡¶∞‡ßã?",
    "‡¶™‡ßú‡¶§‡ßá ‡¶¨‡¶∏!",
    "‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¶‡¶ø‡¶®‡¶ü‡¶æ ‡¶ï‡ßá‡¶Æ‡¶® ‡¶ï‡¶æ‡¶ü‡¶õ‡ßá?",
    "‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶™‡ßú‡ßá‡¶õ‡ßã ‡¶§‡ßã?",
    "‡¶´‡ßã‡¶® ‡¶∞‡ßá‡¶ñ‡ßá ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶ï‡¶æ‡¶∂‡¶ü‡¶æ ‡¶¶‡ßá‡¶ñ‡ßã‡•§"
]

# ‡¶∞‡¶æ‡¶§‡ßá‡¶∞ ‡¶¨‡ßá‡¶≤‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú (‡¶∞‡¶æ‡¶§ ‡ßß‡ß¶‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ß¨‡¶ü‡¶æ)
night_messages = [
    "‡¶ò‡ßÅ‡¶Æ‡¶ø‡ßü‡ßá ‡¶™‡ßú!",
    "‡¶∞‡¶æ‡¶§ ‡¶ú‡ßá‡¶ó‡ßá ‡¶™‡ßú‡¶æ ‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡¶ñ‡¶æ‡¶∞‡¶æ‡¶™‡•§",
    "Vuuuuuuutttttt! üëª",
    "‡¶•‡¶æ‡¶™‡ßç‡¶™‡ßú ‡¶Æ‡¶æ‡¶∞‡¶¨‡ßã, ‡¶ò‡ßÅ‡¶Æ‡¶ø‡ßü‡ßá ‡¶™‡ßú!",
    "‡¶è‡¶§ ‡¶∞‡¶æ‡¶§‡ßá ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶ï‡¶ø?",
    "‡¶ú‡¶≤‡¶¶‡¶ø ‡¶ò‡ßÅ‡¶Æ‡¶æ‡¶ì, ‡¶∏‡¶ï‡¶æ‡¶≤‡ßá ‡¶â‡¶†‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§"
]

bot = telebot.TeleBot(API_TOKEN)

def get_prayer_times():
    """‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá"""
    try:
        # ‡¶¢‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶Ü‡¶®‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
        url = "http://api.aladhan.com/v1/timingsByCity?city=Dhaka&country=Bangladesh&method=1"
        response = requests.get(url).json()
        timings = response['data']['timings']
        return timings
    except:
        return None

def run_task():
    try:
        # ‡ßß. ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡ßü ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶∏‡¶Æ‡ßü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
        now = datetime.now(bd_timezone)
        current_time_str = now.strftime("%H:%M") # ‡¶Ø‡ßá‡¶Æ‡¶®: 14:30
        current_hour = now.hour # ‡¶Ø‡ßá‡¶Æ‡¶®: 14

        print(f"Current BD Time: {current_time_str}")

        # ‡ß®. ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
        prayer_times = get_prayer_times()
        message_to_send = ""
        
        # ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶ì‡ßü‡¶æ‡¶ï‡ßç‡¶§‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶á‡¶Ç‡¶∞‡ßá‡¶ú‡¶ø‡¶§‡ßá API ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶∏‡ßá, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶ï‡¶®‡¶≠‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶õ‡¶ø
        prayer_map = {
            'Fajr': '‡¶´‡¶ú‡¶∞',
            'Dhuhr': '‡¶ú‡ßã‡¶π‡¶∞',
            'Asr': '‡¶Ü‡¶õ‡¶∞',
            'Maghrib': '‡¶Æ‡¶æ‡¶ó‡¶∞‡¶ø‡¶¨',
            'Isha': '‡¶è‡¶∂‡¶æ'
        }

        is_prayer_time = False

        if prayer_times:
            for waqt_en, time_str in prayer_times.items():
                if waqt_en in prayer_map:
                    # API ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶•‡¶æ‡¶ï‡ßá "14:30", ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡ßü‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶¶‡ßá‡¶ñ‡¶ø
                    # ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡ßü ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü‡ßá‡¶∞ ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
                    
                    # (‡¶∏‡¶π‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Ç ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡¶∞‡¶õ‡¶ø, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶Ü‡¶∞‡¶ì ‡¶ï‡¶Æ‡¶™‡ßç‡¶≤‡ßá‡¶ï‡ßç‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®)
                    if time_str == current_time_str:
                        waqt_bn = prayer_map[waqt_en]
                        message_to_send = f"üïå ‡¶è‡¶ñ‡¶® {waqt_bn} ‡¶è‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®‡•§"
                        is_prayer_time = True
                        break

        # ‡ß©. ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶®‡¶æ ‡¶π‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶∞‚Äç‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
        if not is_prayer_time:
            if 6 <= current_hour < 22: # ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ß¨‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∞‡¶æ‡¶§ ‡ßß‡ß¶‡¶ü‡¶æ
                message_to_send = random.choice(day_messages)
            else: # ‡¶∞‡¶æ‡¶§ ‡ßß‡ß¶‡¶ü‡¶æ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ß¨‡¶ü‡¶æ
                message_to_send = random.choice(night_messages)

        # ‡ß™. ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
        print(f"Sending: {message_to_send}")
        msg = bot.send_message(CHANNEL_ID, message_to_send)

        # ‡ß´. ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ (‡¶Æ‡ßá‡¶∏‡ßá‡¶ú‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)
        # ‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶´‡ßç‡¶∞‡¶ø ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡ß©-‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ‡¶≤‡ßá ‡¶ï‡ßã‡¶ü‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§
        # ‡¶§‡¶æ‡¶á ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü (‡ß¨‡ß¶ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°) ‡¶∞‡¶æ‡¶ñ‡¶õ‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶¨‡¶æ‡ßú‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§
        wait_seconds = 60 
        print(f"Waiting {wait_seconds} seconds...")
        time.sleep(wait_seconds)

        # ‡ß¨. ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ
        print("Deleting message...")
        bot.delete_message(CHANNEL_ID, msg.message_id)
        print("Done!")

    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    run_task()
        
